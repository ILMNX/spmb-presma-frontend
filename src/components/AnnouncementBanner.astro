---
// AnnouncementBanner.astro - Announcement modal for landing page
const API_URL = import.meta.env.PUBLIC_API_URL;
---

<div id="announcement-container" class="hidden">
  <!-- Announcement Modal -->
  <div id="announcement-modal" class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4">
      <div class="fixed inset-0 bg-gray-900/70 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>
      <div id="modal-content" class="relative bg-white rounded-2xl shadow-2xl max-w-xl w-full transform transition-all scale-95 opacity-0" style="transition: all 0.3s ease-out;">
        <!-- Modal content will be injected here -->
      </div>
    </div>
  </div>
</div>

<script define:vars={{ API_URL }}>
  // Announcement types and their styling
  const typeStyles = {
    general: {
      gradient: 'from-blue-500 via-blue-600 to-blue-700',
      iconBg: 'bg-blue-100',
      iconColor: 'text-blue-600',
      buttonBg: 'bg-blue-600 hover:bg-blue-700',
      icon: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>`
    },
    info: {
      gradient: 'from-cyan-500 via-cyan-600 to-teal-600',
      iconBg: 'bg-cyan-100',
      iconColor: 'text-cyan-600',
      buttonBg: 'bg-cyan-600 hover:bg-cyan-700',
      icon: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`
    },
    important: {
      gradient: 'from-orange-500 via-red-500 to-red-600',
      iconBg: 'bg-orange-100',
      iconColor: 'text-orange-600',
      buttonBg: 'bg-orange-600 hover:bg-orange-700',
      icon: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`
    },
    exam: {
      gradient: 'from-purple-500 via-purple-600 to-indigo-600',
      iconBg: 'bg-purple-100',
      iconColor: 'text-purple-600',
      buttonBg: 'bg-purple-600 hover:bg-purple-700',
      icon: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`
    },
    payment: {
      gradient: 'from-emerald-500 via-emerald-600 to-green-600',
      iconBg: 'bg-emerald-100',
      iconColor: 'text-emerald-600',
      buttonBg: 'bg-emerald-600 hover:bg-emerald-700',
      icon: `<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>`
    }
  };

  const priorityLabels = {
    urgent: { label: 'ðŸ”´ Penting & Mendesak', class: 'bg-red-100 text-red-700 border border-red-200' },
    high: { label: 'ðŸŸ  Prioritas Tinggi', class: 'bg-orange-100 text-orange-700 border border-orange-200' },
    normal: { label: '', class: '' },
    low: { label: '', class: '' }
  };

  const typeLabels = {
    general: 'Pengumuman',
    info: 'Informasi',
    important: 'Penting',
    exam: 'Ujian',
    payment: 'Pembayaran'
  };

  let announcements = [];
  let currentIndex = 0;
  let dismissedAnnouncements = [];

  // Load dismissed announcements from localStorage
  function loadDismissedAnnouncements() {
    try {
      const stored = localStorage.getItem('dismissed_announcements');
      if (stored) {
        const data = JSON.parse(stored);
        // Clean up old dismissed announcements (older than 24 hours)
        const dayAgo = Date.now() - 24 * 60 * 60 * 1000;
        dismissedAnnouncements = data.filter(item => item.timestamp > dayAgo);
        localStorage.setItem('dismissed_announcements', JSON.stringify(dismissedAnnouncements));
      }
    } catch (e) {
      dismissedAnnouncements = [];
    }
  }

  // Save dismissed announcement
  function dismissAnnouncement(id) {
    dismissedAnnouncements.push({ id, timestamp: Date.now() });
    localStorage.setItem('dismissed_announcements', JSON.stringify(dismissedAnnouncements));
  }

  // Check if announcement is dismissed
  function isAnnouncementDismissed(id) {
    return dismissedAnnouncements.some(item => item.id === id);
  }

  // Fetch announcements
  async function fetchAnnouncements() {
    try {
      const response = await fetch(`${API_URL}/api/announcements/public`);
      if (!response.ok) throw new Error('Failed to fetch');
      const data = await response.json();
      
      if (data.success && data.data.length > 0) {
        // Filter out dismissed announcements
        loadDismissedAnnouncements();
        announcements = data.data.filter(a => !isAnnouncementDismissed(a.id));
        
        if (announcements.length > 0) {
          // Sort: pinned first, then by priority
          announcements.sort((a, b) => {
            if (a.is_pinned !== b.is_pinned) return b.is_pinned ? 1 : -1;
            const priorityOrder = { urgent: 4, high: 3, normal: 2, low: 1 };
            return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
          });
          
          showAnnouncement(announcements[0]);
        }
      }
    } catch (error) {
      console.error('Failed to fetch announcements:', error);
    }
  }

  // Show announcement modal
  function showAnnouncement(announcement) {
    const container = document.getElementById('announcement-container');
    const modal = document.getElementById('announcement-modal');
    const content = document.getElementById('modal-content');
    const style = typeStyles[announcement.type] || typeStyles.general;
    const priority = priorityLabels[announcement.priority] || priorityLabels.normal;
    const typeLabel = typeLabels[announcement.type] || 'Pengumuman';

    const remainingCount = announcements.length - 1;
    const showNavigation = announcements.length > 1;

    content.innerHTML = `
      <div class="overflow-hidden rounded-2xl">
        <!-- Header with gradient -->
        <div class="bg-gradient-to-r ${style.gradient} px-6 py-8 text-white relative overflow-hidden">
          <!-- Decorative circles -->
          <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 rounded-full bg-white/10"></div>
          <div class="absolute bottom-0 left-0 -ml-4 -mb-4 w-24 h-24 rounded-full bg-white/10"></div>
          
          <div class="relative text-center">
            <!-- Icon -->
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/20 backdrop-blur-sm mb-4 shadow-lg">
              <span class="text-white">${style.icon}</span>
            </div>
            
            <!-- Type badge -->
            <div class="mb-3">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-white/20 backdrop-blur-sm">
                ${typeLabel}
              </span>
            </div>
            
            <!-- Title -->
            <h3 class="text-2xl font-bold leading-tight">${announcement.title}</h3>
            
            <!-- Priority badge -->
            ${priority.label ? `
              <div class="mt-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${priority.class}">
                  ${priority.label}
                </span>
              </div>
            ` : ''}
            
            <!-- Pinned indicator -->
            ${announcement.is_pinned ? `
              <div class="mt-2">
                <span class="inline-flex items-center text-xs text-white/80">
                  <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                  </svg>
                  Disematkan
                </span>
              </div>
            ` : ''}
          </div>
        </div>
        
        <!-- Content -->
        <div class="px-6 py-6 max-h-64 overflow-y-auto">
          <div class="prose prose-sm max-w-none">
            <p class="text-gray-700 leading-relaxed whitespace-pre-line text-base">${announcement.content}</p>
          </div>
          
          <!-- Meta info -->
          <div class="mt-4 pt-4 border-t border-gray-100 flex flex-wrap gap-4 text-sm text-gray-500">
            ${announcement.published_at ? `
              <div class="flex items-center gap-1.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span>Dipublikasi: ${new Date(announcement.published_at).toLocaleDateString('id-ID', { 
                  day: 'numeric', 
                  month: 'long', 
                  year: 'numeric' 
                })}</span>
              </div>
            ` : ''}
            ${announcement.expires_at ? `
              <div class="flex items-center gap-1.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Berlaku sampai: ${new Date(announcement.expires_at).toLocaleDateString('id-ID', { 
                  day: 'numeric', 
                  month: 'long', 
                  year: 'numeric' 
                })}</span>
              </div>
            ` : ''}
          </div>
        </div>
        
        <!-- Footer -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
          <div class="flex items-center justify-between">
            <!-- Counter -->
            <div class="text-sm text-gray-500">
              ${showNavigation ? `
                <span class="font-medium">${currentIndex + 1}</span> dari <span class="font-medium">${announcements.length}</span> pengumuman
              ` : ''}
            </div>
            
            <!-- Buttons -->
            <div class="flex items-center gap-3">
              ${showNavigation && currentIndex < announcements.length - 1 ? `
                <button
                  id="modal-skip"
                  class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors"
                >
                  Lewati
                </button>
              ` : ''}
              <button
                id="modal-close"
                class="px-6 py-2.5 ${style.buttonBg} text-white font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-md hover:shadow-lg"
              >
                ${showNavigation && currentIndex < announcements.length - 1 ? 'Berikutnya' : 'Mengerti'}
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    container.classList.remove('hidden');
    
    // Animate in
    requestAnimationFrame(() => {
      content.style.opacity = '1';
      content.style.transform = 'scale(1)';
    });

    // Add event listeners
    document.getElementById('modal-close').addEventListener('click', () => {
      if (showNavigation && currentIndex < announcements.length - 1) {
        nextAnnouncement(announcement.id);
      } else {
        closeModal(announcement.id);
      }
    });

    const skipBtn = document.getElementById('modal-skip');
    if (skipBtn) {
      skipBtn.addEventListener('click', () => nextAnnouncement(announcement.id));
    }

    document.getElementById('modal-backdrop').addEventListener('click', () => closeModal(announcement.id));

    // ESC key to close
    document.addEventListener('keydown', handleEscKey);
  }

  function handleEscKey(e) {
    if (e.key === 'Escape') {
      const currentAnnouncement = announcements[currentIndex];
      if (currentAnnouncement) {
        closeModal(currentAnnouncement.id);
      }
    }
  }

  // Next announcement
  function nextAnnouncement(currentId) {
    dismissAnnouncement(currentId);
    currentIndex++;
    
    const content = document.getElementById('modal-content');
    content.style.opacity = '0';
    content.style.transform = 'scale(0.95)';
    
    setTimeout(() => {
      if (currentIndex < announcements.length) {
        showAnnouncement(announcements[currentIndex]);
      } else {
        hideModal();
      }
    }, 200);
  }

  // Close modal and dismiss all remaining
  function closeModal(id) {
    dismissAnnouncement(id);
    
    // Dismiss all remaining announcements
    announcements.slice(currentIndex + 1).forEach(a => dismissAnnouncement(a.id));
    
    hideModal();
  }

  // Hide modal
  function hideModal() {
    const content = document.getElementById('modal-content');
    content.style.opacity = '0';
    content.style.transform = 'scale(0.95)';
    
    document.removeEventListener('keydown', handleEscKey);
    
    setTimeout(() => {
      document.getElementById('announcement-container').classList.add('hidden');
    }, 200);
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', fetchAnnouncements);
</script>

<style>
  #modal-content {
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  }
  
  .prose p {
    margin: 0;
  }
  
  /* Custom scrollbar for content */
  .max-h-64::-webkit-scrollbar {
    width: 6px;
  }
  
  .max-h-64::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }
  
  .max-h-64::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }
  
  .max-h-64::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
  }
</style>
