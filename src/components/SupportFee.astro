---
import FeeModal from './FeeModal.astro';
import SupportModal from './SupportModal.astro';

const API_URL = import.meta.env.PUBLIC_API_URL ;

// Fetch data
let feesData = { data: [] };
let supportsData = { data: [] };

try {
      const [feesRes, supportsRes] = await Promise.all([
        fetch(`${API_URL}/api/fees`),
        fetch(`${API_URL}/api/supports`)
      ]);
  
  if (feesRes.ok) feesData = await feesRes.json();
  if (supportsRes.ok) supportsData = await supportsRes.json();
} catch (error) {
  console.error('Error fetching data:', error);
}

const fees = feesData.data || [];
const supports = supportsData.data || [];
---

<section class="scroll-mt-20 py-16 bg-gradient-to-br from-gray-50 to-blue-50" id="biaya-dukungan">
  <div class="max-w-7xl mx-auto px-6">
    <!-- Section Header -->
    <div class="text-center mb-12">
      <h2 class="text-4xl font-bold text-gray-900 mb-4">
        Biaya & Dukungan Pendidikan
      </h2>
      <p class="text-xl text-gray-600 max-w-3xl mx-auto">
        Investasi terbaik untuk masa depan cemerlang dengan berbagai program dukungan yang tersedia
      </p>
    </div>

    <!-- Cards Container -->
    <div class="grid md:grid-cols-2 gap-8 max-w-5xl mx-auto">
      <!-- Fee Card -->
      <div class="group cursor-pointer" data-modal-trigger="feeModal">
        <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden group-hover:scale-105">
          <!-- Card Header -->
          <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-2xl font-bold mb-2">Biaya Pendidikan</h3>
                <p class="text-blue-100">Tabel lengkap biaya & cicilan</p>
              </div>
              <div class="bg-white bg-opacity-20 rounded-full p-3">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 6.09L11 10.5l2.41 2.41L12 14.34 9.59 11.91 8.17 13.33 12 17.17l3.83-3.84-1.42-1.42z"/>
                </svg>
              </div>
            </div>
          </div>

          <!-- Card Body -->
          <div class="p-6">
            {fees.length > 0 ? (
              <div class="space-y-4">
                <!-- Fee Preview -->
                <div class="grid grid-cols-2 gap-4">
                  {fees.slice(0, 3).map((fee: any) => (
                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                      <p class="text-sm text-gray-600 mb-1">{fee.title}</p>
                      <p class="font-bold text-blue-600">
                        Rp {fee.amount.toLocaleString('id-ID')}
                      </p>
                    </div>
                  ))}
                  {fees.length > 3 && (
                    <div class="text-center p-3 bg-gray-50 rounded-lg flex items-center justify-center">
                      <p class="text-sm text-gray-500">+{fees.length - 3} lainnya</p>
                    </div>
                  )}
                </div>

                <!-- Total Preview -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                  <p class="text-sm text-blue-600 mb-1">Total Investasi</p>
                  <p class="text-2xl font-bold text-blue-800">
                    Rp {fees.reduce((sum: number, fee: any) => sum + fee.amount, 0).toLocaleString('id-ID')}
                  </p>
                </div>
              </div>
            ) : (
              <div class="text-center py-8 text-gray-500">
                <p>Data biaya belum tersedia</p>
              </div>
            )}

            <!-- CTA -->
            <div class="mt-6 flex items-center justify-center text-blue-600 font-semibold group-hover:text-blue-800 transition-colors">
              <span class="mr-2">Lihat Detail Lengkap</span>
              <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Support Card -->
      <div class="group cursor-pointer" data-modal-trigger="supportModal">
        <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden group-hover:scale-105">
          <!-- Card Header -->
          <div class="bg-gradient-to-r from-green-600 to-teal-600 p-6 text-white">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-2xl font-bold mb-2">Program Dukungan</h3>
                <p class="text-green-100">Bantuan & beasiswa tersedia</p>
              </div>
              <div class="bg-white bg-opacity-20 rounded-full p-3">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm-1 15l-5-5 1.414-1.414L11 14.172l7.586-7.586L20 8l-9 9z"/>
                </svg>
              </div>
            </div>
          </div>

          <!-- Card Body -->
          <div class="p-6">
            {supports.length > 0 ? (
              <div class="space-y-3">
                {supports.slice(0, 4).map((support: any) => (
                  <div class="flex items-center p-3 bg-green-50 rounded-lg border border-green-200">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3 flex-shrink-0"></div>
                    <div>
                      <p class="font-semibold text-gray-900">{support.name}</p>
                      <p class="text-sm text-gray-600">
                        {support.description.length > 60 
                          ? support.description.substring(0, 60) + '...' 
                          : support.description}
                      </p>
                    </div>
                  </div>
                ))}
                
                {supports.length > 4 && (
                  <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="text-sm text-gray-500">+{supports.length - 4} program lainnya</p>
                  </div>
                )}
              </div>
            ) : (
              <div class="text-center py-8 text-gray-500">
                <p>Data program dukungan belum tersedia</p>
              </div>
            )}

            <!-- CTA -->
            <div class="mt-6 flex items-center justify-center text-green-600 font-semibold group-hover:text-green-800 transition-colors">
              <span class="mr-2">Lihat Semua Program</span>
              <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modals -->
<FeeModal fees={fees} />
<SupportModal supports={supports} />

<script>
  // Use IIFE to avoid global namespace pollution
  (function() {
    'use strict';

    // Modal management class
    class ModalManager {
      activeModal: string | null = null;
      constructor() {
        this.activeModal = null;
        this.init();
      }

      init() {
        this.bindEvents();
      }

      bindEvents() {
        // Handle modal triggers
        document.addEventListener('click', (e) => {
          const trigger = (e.target as HTMLElement)?.closest?.('[data-modal-trigger]');
          if (trigger) {
            e.preventDefault();
            const modalId = (trigger as HTMLElement).dataset.modalTrigger;
            if (typeof modalId === 'string') {
              this.openModal(modalId);
            }
          }

          // Handle modal close buttons
          const closeBtn = e.target && (e.target as HTMLElement).closest?.('[data-modal-close]');
          if (closeBtn) {
            e.preventDefault();
            this.closeActiveModal();
          }

          // Handle backdrop clicks
          const modalBackdrop = e.target && (e.target as HTMLElement).closest?.('[data-modal-backdrop]');
          if (modalBackdrop && e.target === modalBackdrop) {
            this.closeActiveModal();
          }
        });

        // Handle escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.activeModal) {
            this.closeActiveModal();
          }
        });

        // Handle browser back/forward
        window.addEventListener('popstate', () => {
          if (this.activeModal) {
            this.closeActiveModal();
          }
        });
      }

      openModal(modalId: string) {
        const modal = document.getElementById(modalId);
        if (!modal) {
          console.warn(`Modal with id "${modalId}" not found`);
          return;
        }

        // Close any active modal first
        if (this.activeModal) {
          this.closeModal(this.activeModal);
        }

        this.activeModal = modalId;
        
        // Show modal
        modal.classList.remove('hidden');
        
        // Force reflow for animation
        modal.offsetHeight;
        
        // Apply show classes
        modal.classList.remove('opacity-0');
        modal.classList.add('opacity-100');
        
        const content = modal.querySelector('.transform');
        if (content) {
          content.classList.remove('scale-95');
          content.classList.add('scale-100');
        }
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
        
        // Add to history for back button support
        if (history.pushState) {
          history.pushState({ modal: modalId }, '', location.href);
        }
        
        // Focus management for accessibility
        this.trapFocus(modal);
      }

      closeModal(modalId: string) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        // Apply hide classes
        modal.classList.remove('opacity-100');
        modal.classList.add('opacity-0');
        
        const content = modal.querySelector('.transform');
        if (content) {
          content.classList.remove('scale-100');
          content.classList.add('scale-95');
        }
        
        // Hide modal after animation
        setTimeout(() => {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }, 300);

        this.activeModal = null;
      }

      closeActiveModal() {
        if (this.activeModal) {
          this.closeModal(this.activeModal);
          
          // Handle history
          if (history.state && history.state.modal) {
            history.back();
          }
        }
      }

      trapFocus(modal: HTMLElement) {
        const focusableElements = modal.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        
        if (focusableElements.length === 0) return;
        
        const firstFocusable = focusableElements[0];
        const lastFocusable = focusableElements[focusableElements.length - 1];
        
        // Focus first element
        (firstFocusable as HTMLElement).focus();
        
        // Handle tab cycling
        modal.addEventListener('keydown', (e) => {
          if (e.key === 'Tab') {
            if (e.shiftKey) {
              if (document.activeElement === firstFocusable) {
                e.preventDefault();
                (lastFocusable as HTMLElement).focus();
              }
            } else {
              if (document.activeElement === lastFocusable) {
                e.preventDefault();
                (firstFocusable as HTMLElement).focus();
              }
            }
          }
        });
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        new ModalManager();
      });
    } else {
      new ModalManager();
    }
  })();
</script>