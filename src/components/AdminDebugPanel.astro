---
const SHOW_DEBUG = import.meta.env.MODE === 'development' || import.meta.env.PUBLIC_DEBUG_MODE === 'true';
export const prerender = false;
---

{SHOW_DEBUG ? (
  <section id="admin-debug-panel" class="max-w-xl mx-auto mb-6">
    <div class="bg-gray-900 text-white rounded-lg shadow-lg p-4 font-mono text-sm">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold text-yellow-400">Admin Debug Information</h3>
        <div class="flex items-center gap-2">
          <button id="adb-refresh" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Refresh</button>
          <button id="adb-toggle" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Hide</button>
        </div>
      </div>

      <div id="adb-content" class="space-y-2">
        <div class="flex items-start">
          <span class="text-gray-400 w-36">Name:</span>
          <span id="adb-name" class="text-gray-200">Loading…</span>
        </div>
        <div class="flex items-start">
          <span class="text-gray-400 w-36">Role:</span>
          <span id="adb-role" class="text-gray-200">Loading…</span>
        </div>
        <div class="flex items-start">
          <span class="text-gray-400 w-36">School Access:</span>
          <span id="adb-school" class="text-gray-200">Loading…</span>
        </div>

        <div class="mt-3 pt-3 border-t border-gray-700">
          <div class="flex items-center gap-2 text-xs text-gray-400">
            <span id="adb-status">Waiting to fetch /api/user/me</span>
          </div>
        </div>
      </div>
    </div>
  </section>
) : null}
  
<script type="module">
  // client-only logic
  (function () {
    if (!document.getElementById('admin-debug-panel')) return;

    const nameEl = document.getElementById('adb-name');
    const roleEl = document.getElementById('adb-role');
    const schoolEl = document.getElementById('adb-school');
    const statusEl = document.getElementById('adb-status');
    const contentEl = document.getElementById('adb-content');
    const toggleBtn = document.getElementById('adb-toggle');
    const refreshBtn = document.getElementById('adb-refresh');

    function renderBadge(text, colorClass) {
      const wrapper = document.createElement('span');
      wrapper.className = `inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${colorClass} text-white`;
      wrapper.textContent = text;
      return wrapper;
    }

    async function loadUser() {
      statusEl.textContent = 'Fetching /api/user/me ...';
      try {
        const res = await fetch('/api/user/me', { credentials: 'same-origin', headers: { Accept: 'application/json' } });
        if (!res.ok) {
          statusEl.textContent = `Fetch failed: ${res.status}`;
          nameEl.textContent = '-';
          roleEl.textContent = '-';
          schoolEl.textContent = '-';
          return;
        }
        const data = await res.json();

        const user = data?.data || data || {};
        const name = user.name || user.full_name || '-';
        const role = user.role || '-';
        const perm = user.admin_permission || user.adminPermission || null;
        const school = perm?.school_type || null;

        nameEl.textContent = name;
        roleEl.textContent = role;

        // clear previous content
        schoolEl.innerHTML = '';

        if (role === 'admin' && school) {
          if (school === 'both') {
            schoolEl.appendChild(renderBadge('Superadmin (All Access)', 'bg-green-500'));
          } else if (school === 'SMA') {
            schoolEl.appendChild(renderBadge('SMA', 'bg-blue-500'));
          } else if (school === 'SMK') {
            schoolEl.appendChild(renderBadge('SMK', 'bg-orange-500'));
          } else {
            schoolEl.textContent = school;
          }
        } else {
          schoolEl.textContent = school || '-';
        }

        statusEl.textContent = `Fetched at ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        console.error('AdminDebugPanel fetch error', err);
        statusEl.textContent = 'Error fetching user info';
        nameEl.textContent = '-';
        roleEl.textContent = '-';
        schoolEl.textContent = '-';
      }
    }

    // toggle visibility
    toggleBtn?.addEventListener('click', () => {
      if (!contentEl) return;
      if (contentEl.style.display === 'none') {
        contentEl.style.display = '';
        toggleBtn.textContent = 'Hide';
      } else {
        contentEl.style.display = 'none';
        toggleBtn.textContent = 'Show';
      }
    });

    refreshBtn?.addEventListener('click', () => loadUser());

    // initial load
    loadUser();
  })();
</script>

<style>
  /* small client-only tweaks */
  #admin-debug-panel .bg-gray-900 { background-color: rgba(17,24,39,0.98); }
</style>