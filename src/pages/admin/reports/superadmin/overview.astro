---
import DashboardLayout from '../../../../layouts/DashboardLayout.astro';

---

<DashboardLayout title="Superadmin Overview">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Overview Keseluruhan</h1>
        <p class="text-gray-600 mt-1">Statistik pendaftaran seluruh unit (SMA & SMK)</p>
      </div>
      <div class="flex gap-3">
        <select id="filterPeriod" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="all">Semua Periode</option>
          <option value="today">Hari Ini</option>
          <option value="week">Minggu Ini</option>
          <option value="month">Bulan Ini</option>
        </select>
        <button id="btnExport" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          Export
        </button>
      </div>
    </div>

    <!-- Total Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-100">Total Pendaftar</p>
            <p id="totalRegistrations" class="text-4xl font-bold">0</p>
          </div>
          <svg class="w-12 h-12 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
        </div>
      </div>

      <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-100">Pembayaran Lunas</p>
            <p id="totalPaid" class="text-4xl font-bold">0</p>
          </div>
          <svg class="w-12 h-12 text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
      </div>

      <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-100">Tervalidasi</p>
            <p id="totalValidated" class="text-4xl font-bold">0</p>
          </div>
          <svg class="w-12 h-12 text-purple-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
      </div>

      <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-orange-100">Siap Tes</p>
            <p id="totalReady" class="text-4xl font-bold">0</p>
          </div>
          <svg class="w-12 h-12 text-orange-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- School Comparison -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- SMA Card -->
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="bg-blue-600 text-white px-6 py-4">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
            SMA
          </h3>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
              <div id="smaTotal" class="text-3xl font-bold text-blue-600">0</div>
              <div class="text-sm text-gray-600">Total</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
              <div id="smaPaid" class="text-3xl font-bold text-green-600">0</div>
              <div class="text-sm text-gray-600">Lunas</div>
            </div>
          </div>
          <div id="smaMajors" class="space-y-3">
            <!-- Dynamic content -->
          </div>
        </div>
      </div>

      <!-- SMK Card -->
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="bg-purple-600 text-white px-6 py-4">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            SMK
          </h3>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
              <div id="smkTotal" class="text-3xl font-bold text-purple-600">0</div>
              <div class="text-sm text-gray-600">Total</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
              <div id="smkPaid" class="text-3xl font-bold text-green-600">0</div>
              <div class="text-sm text-gray-600">Lunas</div>
            </div>
          </div>
          <div id="smkMajors" class="space-y-3">
            <!-- Dynamic content -->
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- School Distribution -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">Distribusi per Unit</h3>
        <div class="h-64">
          <canvas id="schoolDistChart"></canvas>
        </div>
      </div>

      <!-- Payment Status -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">Status Pembayaran</h3>
        <div class="h-64">
          <canvas id="paymentChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Revenue Summary -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold mb-4">Ringkasan Pendapatan</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="border rounded-lg p-4">
          <div class="text-sm text-gray-600">Total Revenue</div>
          <div id="totalRevenue" class="text-2xl font-bold text-green-600">Rp 0</div>
          <div class="text-xs text-gray-500 mt-1">Dari semua pembayaran lunas</div>
        </div>
        <div class="border rounded-lg p-4">
          <div class="text-sm text-gray-600">Revenue SMA</div>
          <div id="smaRevenue" class="text-2xl font-bold text-blue-600">Rp 0</div>
        </div>
        <div class="border rounded-lg p-4">
          <div class="text-sm text-gray-600">Revenue SMK</div>
          <div id="smkRevenue" class="text-2xl font-bold text-purple-600">Rp 0</div>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
      <p class="mt-4 text-gray-600">Memuat data...</p>
    </div>

    <!-- Comparison Table -->
    <div class="bg-white rounded-lg shadow">
      <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold">Perbandingan Detail</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Metrik</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase bg-blue-50">SMA</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase bg-purple-50">SMK</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Total</th>
            </tr>
          </thead>
          <tbody id="comparisonTable" class="divide-y divide-gray-200">
            <tr>
              <td colspan="4" class="px-6 py-4 text-center text-gray-500">Memuat data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    import { api } from '../../../../lib/api';
    import Chart from 'chart.js/auto';

    let schoolDistChart: Chart | null = null;
    let paymentChart: Chart | null = null;

    function formatCurrency(amount: number): string {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(amount);
    }

    async function loadData() {
      const loading = document.getElementById('loading');
      loading?.classList.remove('hidden');

      try {
        const response = await api.get('/api/admin/reports/superadmin/overview');
        
        if (response.data.success) {
          renderData(response.data.data);
        }
      } catch (error) {
        console.error('Error loading data:', error);
      } finally {
        loading?.classList.add('hidden');
      }
    }

    function renderData(data: any) {
      // Total summary - use total_statistics
      const stats = data.total_statistics || {};
      document.getElementById('totalRegistrations')!.textContent = stats.registrations?.total || 0;
      document.getElementById('totalPaid')!.textContent = stats.payments?.paid || 0;
      document.getElementById('totalValidated')!.textContent = stats.validation?.validated || 0;
      document.getElementById('totalReady')!.textContent = stats.validation?.test_ready || 0;

      // SMA breakdown - use breakdown_by_school
      const sma = data.breakdown_by_school?.sma || {};
      document.getElementById('smaTotal')!.textContent = sma.total || 0;
      document.getElementById('smaPaid')!.textContent = sma.status?.payment_confirmed || 0;
      renderMajorsList('smaMajors', sma.by_major || [], 'blue');

      // SMK breakdown
      const smk = data.breakdown_by_school?.smk || {};
      document.getElementById('smkTotal')!.textContent = smk.total || 0;
      document.getElementById('smkPaid')!.textContent = smk.status?.payment_confirmed || 0;
      renderMajorsList('smkMajors', smk.by_major || [], 'purple');

      // Revenue from total_statistics
      document.getElementById('totalRevenue')!.textContent = formatCurrency(stats.payments?.revenue || 0);
      
      // Calculate revenue per school from payment_comparison
      const paymentComparison = data.payment_comparison || [];
      let smaRevenue = 0, smkRevenue = 0;
      paymentComparison.forEach((p: any) => {
        if (p.type === 'SMA') smaRevenue += Number(p.total_amount || 0);
        if (p.type === 'SMK') smkRevenue += Number(p.total_amount || 0);
      });
      document.getElementById('smaRevenue')!.textContent = formatCurrency(smaRevenue);
      document.getElementById('smkRevenue')!.textContent = formatCurrency(smkRevenue);

      // Charts
      renderSchoolDistChart(sma.total || 0, smk.total || 0);
      renderPaymentChart(sma, smk);

      // Comparison table
      renderComparisonTable(data);
    }

    function renderMajorsList(containerId: string, majors: any[], color: string) {
      const container = document.getElementById(containerId);
      if (!container) return;

      container.innerHTML = majors.slice(0, 5).map((m: any) => `
        <div class="flex items-center justify-between">
          <span class="text-sm text-gray-700">${m.display_name || m.major}</span>
          <span class="text-sm font-semibold text-${color}-600">${m.count}</span>
        </div>
      `).join('');
    }

    function renderSchoolDistChart(sma: number, smk: number) {
      const canvas = document.getElementById('schoolDistChart') as HTMLCanvasElement;
      if (!canvas) return;

      if (schoolDistChart) {
        schoolDistChart.destroy();
      }

      schoolDistChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
          labels: ['SMA', 'SMK'],
          datasets: [{
            data: [sma, smk],
            backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(147, 51, 234, 0.8)'],
            borderColor: ['rgba(59, 130, 246, 1)', 'rgba(147, 51, 234, 1)'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function renderPaymentChart(sma: any, smk: any) {
      const canvas = document.getElementById('paymentChart') as HTMLCanvasElement;
      if (!canvas) return;

      if (paymentChart) {
        paymentChart.destroy();
      }

      const smaStatus = sma.status || {};
      const smkStatus = smk.status || {};

      paymentChart = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: ['SMA', 'SMK'],
          datasets: [
            {
              label: 'Lunas',
              data: [smaStatus.payment_confirmed || 0, smkStatus.payment_confirmed || 0],
              backgroundColor: 'rgba(34, 197, 94, 0.8)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 1
            },
            {
              label: 'Pending',
              data: [smaStatus.pending_payment || 0, smkStatus.pending_payment || 0],
              backgroundColor: 'rgba(251, 191, 36, 0.8)',
              borderColor: 'rgba(251, 191, 36, 1)',
              borderWidth: 1
            },
            {
              label: 'Draft',
              data: [smaStatus.draft || 0, smkStatus.draft || 0],
              backgroundColor: 'rgba(156, 163, 175, 0.8)',
              borderColor: 'rgba(156, 163, 175, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          },
          plugins: {
            legend: { position: 'top' }
          }
        }
      });
    }

    function renderComparisonTable(data: any) {
      const tbody = document.getElementById('comparisonTable');
      if (!tbody) return;

      const sma = data.breakdown_by_school?.sma || {};
      const smk = data.breakdown_by_school?.smk || {};
      const stats = data.total_statistics || {};

      const smaStatus = sma.status || {};
      const smkStatus = smk.status || {};

      const metrics = [
        { label: 'Total Pendaftar', sma: sma.total, smk: smk.total, total: stats.registrations?.total },
        { label: 'Pembayaran Lunas', sma: smaStatus.payment_confirmed, smk: smkStatus.payment_confirmed, total: stats.payments?.paid },
        { label: 'Validasi Lengkap', sma: sma.validated, smk: smk.validated, total: stats.validation?.validated },
        { label: 'Siap Tes', sma: sma.test_ready, smk: smk.test_ready, total: stats.validation?.test_ready },
        { label: 'Pending Payment', sma: smaStatus.pending_payment, smk: smkStatus.pending_payment, total: (smaStatus.pending_payment || 0) + (smkStatus.pending_payment || 0) },
        { label: 'Draft', sma: smaStatus.draft, smk: smkStatus.draft, total: (smaStatus.draft || 0) + (smkStatus.draft || 0) }
      ];

      tbody.innerHTML = metrics.map(m => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 font-medium">${m.label}</td>
          <td class="px-6 py-4 text-center bg-blue-50 font-semibold text-blue-600">${m.sma || 0}</td>
          <td class="px-6 py-4 text-center bg-purple-50 font-semibold text-purple-600">${m.smk || 0}</td>
          <td class="px-6 py-4 text-center font-bold">${m.total || 0}</td>
        </tr>
      `).join('');
    }

    // Filter
    document.getElementById('filterPeriod')?.addEventListener('change', (e) => {
      const value = (e.target as HTMLSelectElement).value;
      // Reload with period filter
      loadData();
    });

    // Export
    document.getElementById('btnExport')?.addEventListener('click', async () => {
      try {
        const response = await api.get('/api/admin/reports/superadmin/overview?export=true', {
          responseType: 'blob'
        });
        
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `superadmin-overview-${new Date().toISOString().split('T')[0]}.xlsx`);
        document.body.appendChild(link);
        link.click();
        link.remove();
      } catch (error) {
        console.error('Export error:', error);
        alert('Gagal export data');
      }
    });

    // Initial load
    loadData();
  </script>
</DashboardLayout>
