---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Laporan Pendaftaran per Jurusan">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Laporan Pendaftaran per Jurusan</h1>
          <p class="text-gray-600 mt-1">Analisis data pendaftaran berdasarkan program studi</p>
        </div>
        <div class="flex gap-2">
          <button id="btn-refresh" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh
          </button>
          <button
            id="exportPdfBtn"
            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Export PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div id="schoolTypeFilterContainer" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Sekolah</label>
          <select id="schoolTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="all">Semua</option>
            <option value="sma">SMA</option>
            <option value="smk">SMK</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
          <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
          <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">&nbsp;</label>
          <button id="applyFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            Terapkan Filter
          </button>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
      <p class="mt-4 text-gray-600">Loading...</p>
    </div>

    <!-- Error -->
    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <p class="text-red-800" id="error-text"></p>
    </div>

    <!-- Content -->
    <div id="content" class="hidden">
      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
        <div>
          <p class="text-blue-100 text-sm">Total Programs</p>
          <p id="stat-programs" class="text-3xl font-bold text-white">0</p>
        </div>
        <div class="bg-white/20 p-3 rounded-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
        </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
        <div>
          <p class="text-emerald-100 text-sm">Total Registrations</p>
          <p id="stat-registrations" class="text-3xl font-bold text-white">0</p>
        </div>
        <div class="bg-white/20 p-3 rounded-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
          </svg>
        </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-violet-500 to-purple-600 rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
        <div>
          <p class="text-violet-100 text-sm">Total Accepted</p>
          <p id="stat-accepted" class="text-3xl font-bold text-white">0</p>
        </div>
        <div class="bg-white/20 p-3 rounded-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg shadow-md p-6">
          <div class="flex items-center justify-between">
        <div>
          <p class="text-amber-100 text-sm">Payment Rate</p>
          <p id="stat-payment-rate" class="text-3xl font-bold text-white">0%</p>
        </div>
        <div class="bg-white/20 p-3 rounded-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Registration by Program Chart -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Registration by Program</h3>
          <canvas id="programChart" class="w-full" style="max-height: 300px;"></canvas>
        </div>

        <!-- School Type Distribution Chart -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">School Type Distribution</h3>
          <canvas id="schoolTypeChart" class="w-full" style="max-height: 300px;"></canvas>
        </div>
      </div>

      <!-- Detailed Table -->
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800">Detail Statistik per Jurusan</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jurusan</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rejected</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approved</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval Rate</th>
              </tr>
            </thead>
            <tbody id="table-body" class="bg-white divide-y divide-gray-200">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>

<script>
  import { api } from '../../../lib/api';
  import Chart from 'chart.js/auto';

  interface MajorData {
    major: string;
    display_name?: string;
    type: string;
    total: number;
    pending: number;
    approved: number;
    rejected: number;
  }

  let data: MajorData[] = [];
  let adminSchoolType: string | null = null;
  let programChart: Chart | null = null;
  let schoolTypeChart: Chart | null = null;

  async function loadData(): Promise<void> {
    show('loading');
    
    try {
      const params = new URLSearchParams();
      
      const schoolTypeFilter = document.getElementById('schoolTypeFilter') as HTMLSelectElement | null;
      const startDate = document.getElementById('startDate') as HTMLInputElement | null;
      const endDate = document.getElementById('endDate') as HTMLInputElement | null;

      if (schoolTypeFilter && schoolTypeFilter.value !== 'all') {
        params.append('school_type', schoolTypeFilter.value);
      }
      if (startDate?.value) {
        params.append('start_date', startDate.value);
      }
      if (endDate?.value) {
        params.append('end_date', endDate.value);
      }

      const response = await api.get(`/api/admin/reports/registrations-by-major?${params}`);
      
      if (response.data.success) {
        data = response.data.data || [];
        adminSchoolType = response.data.meta?.school_type || null;
        
        // Show school type filter for superadmin
        if (adminSchoolType === 'both') {
          document.getElementById('schoolTypeFilterContainer')?.classList.remove('hidden');
        }
        
        render();
        renderCharts();
        show('content');
      } else {
        throw new Error(response.data.message || 'Error loading data');
      }
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Unknown error';
      console.error('Load data error:', err);
      showError(errorMessage);
    }
  }

  function render(): void {
    if (!data || data.length === 0) return;

    // Update summary stats
    const statPrograms = document.getElementById('stat-programs');
    const statRegistrations = document.getElementById('stat-registrations');
    const statAccepted = document.getElementById('stat-accepted');
    const statPaymentRate = document.getElementById('stat-payment-rate');

    const totalRegistrations = data.reduce((sum, m) => sum + m.total, 0);
    const totalApproved = data.reduce((sum, m) => sum + m.approved, 0);
    const approvalRate = totalRegistrations > 0 
      ? Math.round((totalApproved / totalRegistrations) * 100) 
      : 0;

    if (statPrograms) statPrograms.textContent = String(data.length);
    if (statRegistrations) statRegistrations.textContent = String(totalRegistrations);
    if (statAccepted) statAccepted.textContent = String(totalApproved);
    if (statPaymentRate) statPaymentRate.textContent = `${approvalRate}%`;

    // Render table
    renderTable(data);
  }

  function renderTable(majors: MajorData[]): void {
    const tbody = document.getElementById('table-body');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (majors.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="px-6 py-8 text-center text-gray-500">
            Tidak ada data jurusan
          </td>
        </tr>
      `;
      return;
    }

    majors.forEach(major => {
      const approvalRate = major.total > 0 
        ? Math.round((major.approved / major.total) * 100) 
        : 0;
      const schoolType = major.type?.toLowerCase() || 'sma';

      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50 transition-colors';
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${major.display_name || major.major || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 py-1 text-xs rounded-full ${schoolType === 'sma' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">
            ${major.type || '-'}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-gray-700 font-semibold">${major.total}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">${major.pending}</span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">${major.rejected || 0}</span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${major.approved}</span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="flex items-center">
            <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
              <div class="bg-green-600 h-2 rounded-full" style="width: ${approvalRate}%"></div>
            </div>
            <span class="text-sm text-gray-700">${approvalRate}%</span>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderCharts(): void {
    if (!data || data.length === 0) return;

    // Destroy existing charts
    if (programChart) programChart.destroy();
    if (schoolTypeChart) schoolTypeChart.destroy();

    // Sort by total and get top 10
    const topMajors = [...data].sort((a, b) => b.total - a.total).slice(0, 10);

    // Program Bar Chart
    const programCtx = document.getElementById('programChart') as HTMLCanvasElement;
    if (programCtx) {
      programChart = new Chart(programCtx, {
        type: 'bar',
        data: {
          labels: topMajors.map(d => {
            const name = d.display_name || d.major || '-';
            return name.length > 20 ? name.substring(0, 20) + '...' : name;
          }),
          datasets: [{
            label: 'Total Pendaftar',
            data: topMajors.map(d => d.total),
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // School Type Doughnut Chart
    const schoolTypeCtx = document.getElementById('schoolTypeChart') as HTMLCanvasElement;
    if (schoolTypeCtx) {
      const smaTotal = data.filter(m => m.type?.toUpperCase() === 'SMA').reduce((s, m) => s + m.total, 0);
      const smkTotal = data.filter(m => m.type?.toUpperCase() === 'SMK').reduce((s, m) => s + m.total, 0);

      if (smaTotal > 0 || smkTotal > 0) {
        schoolTypeChart = new Chart(schoolTypeCtx, {
          type: 'doughnut',
          data: {
            labels: ['SMA', 'SMK'],
            datasets: [{
              data: [smaTotal, smkTotal],
              backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(147, 51, 234, 0.8)'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }
    }
  }

  async function exportPDF(): Promise<void> {
    const btn = document.getElementById('exportPdfBtn') as HTMLButtonElement | null;
    if (!btn) return;

    const originalHTML = btn.innerHTML;

    try {
      btn.disabled = true;
      btn.innerHTML = `
        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Generating...
      `;

      const params = new URLSearchParams();
      
      const schoolTypeFilter = document.getElementById('schoolTypeFilter') as HTMLSelectElement | null;
      const startDate = document.getElementById('startDate') as HTMLInputElement | null;
      const endDate = document.getElementById('endDate') as HTMLInputElement | null;

      if (schoolTypeFilter && schoolTypeFilter.value !== 'all') {
        params.append('school_type', schoolTypeFilter.value);
      }
      if (startDate?.value) {
        params.append('start_date', startDate.value);
      }
      if (endDate?.value) {
        params.append('end_date', endDate.value);
      }

      const response = await api.get(`/api/admin/reports/registrations-by-major/export-pdf?${params}`, {
        responseType: 'blob'
      });

      const blob = new Blob([response.data], { type: 'application/pdf' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `laporan-jurusan-${new Date().toISOString().split('T')[0]}.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Unknown error';
      console.error('Export error:', err);
      alert('Gagal export PDF: ' + errorMessage);
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  }

  function show(id: string): void {
    ['loading', 'error', 'content'].forEach(el => {
      document.getElementById(el)?.classList.add('hidden');
    });
    document.getElementById(id)?.classList.remove('hidden');
  }

  function showError(msg: string): void {
    const errorText = document.getElementById('error-text');
    if (errorText) errorText.textContent = msg;
    show('error');
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (programChart) programChart.destroy();
    if (schoolTypeChart) schoolTypeChart.destroy();
  });

  document.addEventListener('DOMContentLoaded', () => {
    loadData();
    
    document.getElementById('exportPdfBtn')?.addEventListener('click', exportPDF);
    document.getElementById('applyFilterBtn')?.addEventListener('click', loadData);
    document.getElementById('btn-refresh')?.addEventListener('click', loadData);
  });
</script>