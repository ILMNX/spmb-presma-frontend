---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Manage Testimonials">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Manage Testimonials</h1>
        <p class="text-gray-600 mt-2">Manage testimonials from students, alumni, and parents</p>
      </div>
      <button
        id="btnAddTestimonial"
        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Add Testimonial
      </button>
    </div>

    <!-- Filter Tabs -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
      <div class="flex border-b border-gray-200">
        <button class="tab-btn active px-6 py-3 font-medium text-gray-700 border-b-2 border-blue-600" data-filter="all">
          All Testimonials
        </button>
        <button class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" data-filter="alumni">
          Alumni
        </button>
        <button class="tab-btn px-6 py-3 font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" data-filter="regular">
          Students & Parents
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      <p class="text-gray-600 mt-4">Loading testimonials...</p>
    </div>

    <!-- Testimonials Table -->
    <div id="testimonialsTable" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Photo</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="testimonialsTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Data will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center hidden">
      <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
      </svg>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No testimonials found</h3>
      <p class="text-gray-600 mb-4">Get started by adding your first testimonial</p>
      <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
        Add Testimonial
      </button>
    </div>
  </div>

  <!-- Modal -->
  <div id="testimonialModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <!-- Modal Header -->
      <div class="flex justify-between items-center p-6 border-b border-gray-200">
        <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Add Testimonial</h2>
        <button id="btnCloseModal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Modal Body -->
      <form id="testimonialForm" class="p-6 space-y-4">
        <input type="hidden" id="testimonialId" />

        <!-- Name -->
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
            placeholder="Enter name"
          />
        </div>

        <!-- Role -->
        <div>
          <label for="role" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
          <input
            type="text"
            id="role"
            name="role"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
            placeholder="e.g., Student, Alumni, Parent"
          />
        </div>

        <!-- Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
          <div class="flex gap-4">
            <label class="flex items-center">
              <input type="radio" name="is_alumni" value="false" checked class="mr-2" />
              <span>Regular (Student/Parent)</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="is_alumni" value="true" class="mr-2" />
              <span>Alumni</span>
            </label>
          </div>
        </div>

        <!-- Batch (for Alumni) -->
        <div id="batchField" class="hidden">
          <label for="batch" class="block text-sm font-medium text-gray-700 mb-2">Batch/Year</label>
          <input
            type="text"
            id="batch"
            name="batch"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
            placeholder="e.g., 2023"
          />
        </div>

        <!-- Quote -->
        <div>
          <label for="quote" class="block text-sm font-medium text-gray-700 mb-2">Quote</label>
          <input
            type="text"
            id="quote"
            name="quote"
            maxlength="200"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
            placeholder="Short quote (max 200 characters)"
          />
        </div>

        <!-- Message -->
        <div>
          <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Message *</label>
          <textarea
            id="message"
            name="message"
            required
            rows="4"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
            placeholder="Full testimonial message"
          ></textarea>
        </div>

        <!-- Photo URL -->
        <div>
          <label for="photo_url" class="block text-sm font-medium text-gray-700 mb-2">Photo URL</label>
          <input
            type="url"
            id="photo_url"
            name="photo_url"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
            placeholder="https://example.com/photo.jpg"
          />
        </div>

        <!-- Video URL -->
        <div>
          <label for="video_url" class="block text-sm font-medium text-gray-700 mb-2">Video URL</label>
          <input
            type="url"
            id="video_url"
            name="video_url"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
            placeholder="https://youtube.com/watch?v=..."
          />
        </div>

        <!-- Order -->
        <div>
          <label for="order" class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
          <input
            type="number"
            id="order"
            name="order"
            min="0"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"
            placeholder="0"
          />
        </div>

        <!-- Active Status -->
        <div class="flex items-center">
          <input
            type="checkbox"
            id="is_active"
            name="is_active"
            checked
            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-600"
          />
          <label for="is_active" class="ml-2 text-sm font-medium text-gray-700">Active</label>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end gap-3 pt-4">
          <button
            type="button"
            id="btnCancelForm"
            class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="btnSubmitForm"
            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
          >
            Save Testimonial
          </button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script>
  const API_BASE_URL = import.meta.env.PUBLIC_API_URL;
  
  // Helper to get token from sessionStorage (aligned with authStore)
  function getSecureToken() {
    return sessionStorage.getItem('auth_token');
  }
  
  let testimonials: any[] = [];
  let currentFilter = 'all';
  let editingId: number | null = null;

  // DOM Elements
  const loadingState = document.getElementById('loadingState')!;
  const testimonialsTable = document.getElementById('testimonialsTable')!;
  const emptyState = document.getElementById('emptyState')!;
  const tableBody = document.getElementById('testimonialsTableBody')!;
  const modal = document.getElementById('testimonialModal')!;
  const modalTitle = document.getElementById('modalTitle')!;
  const form = document.getElementById('testimonialForm') as HTMLFormElement;
  const batchField = document.getElementById('batchField')!;

  // Load testimonials
  async function loadTestimonials() {
    try {
      loadingState.classList.remove('hidden');
      testimonialsTable.classList.add('hidden');
      emptyState.classList.add('hidden');

      const token = getSecureToken();
      const response = await fetch(`${API_BASE_URL}/api/testimonials`, {
        headers: token ? { 'Authorization': `Bearer ${token}` } : {}
      });

      if (!response.ok) throw new Error('Failed to load testimonials');

      const data = await response.json();
      testimonials = data.data?.all || [];

      renderTestimonials();
    } catch (error) {
      console.error('Error loading testimonials:', error);
      alert('Failed to load testimonials. Please try again.');
    } finally {
      loadingState.classList.add('hidden');
    }
  }

  // Render testimonials
  function renderTestimonials() {
    const filtered = filterTestimonials();

    if (filtered.length === 0) {
      emptyState.classList.remove('hidden');
      testimonialsTable.classList.add('hidden');
      return;
    }

    emptyState.classList.add('hidden');
    testimonialsTable.classList.remove('hidden');

    tableBody.innerHTML = filtered.map(t => `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.order || 0}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          ${t.photo_url 
            ? `<img src="${t.photo_url}" alt="${t.name}" class="w-10 h-10 rounded-full object-cover" />`
            : `<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                <span class="text-gray-600 font-medium">${t.name?.charAt(0) || '?'}</span>
               </div>`
          }
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm font-medium text-gray-900">${t.name}</div>
          ${t.batch ? `<div class="text-xs text-gray-500">Batch ${t.batch}</div>` : ''}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${t.role || '-'}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 py-1 text-xs font-medium rounded-full ${
            t.is_alumni 
              ? 'bg-purple-100 text-purple-800' 
              : 'bg-blue-100 text-blue-800'
          }">
            ${t.is_alumni ? 'Alumni' : 'Regular'}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 py-1 text-xs font-medium rounded-full ${
            t.is_active 
              ? 'bg-green-100 text-green-800' 
              : 'bg-gray-100 text-gray-800'
          }">
            ${t.is_active ? 'Active' : 'Inactive'}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
          <button
            class="text-blue-600 hover:text-blue-900"
            onclick="editTestimonial(${t.id})"
          >
            Edit
          </button>
          <button
            class="text-red-600 hover:text-red-900"
            onclick="deleteTestimonial(${t.id})"
          >
            Delete
          </button>
        </td>
      </tr>
    `).join('');
  }

  // Filter testimonials
  function filterTestimonials() {
    if (currentFilter === 'all') return testimonials;
    if (currentFilter === 'alumni') return testimonials.filter(t => t.is_alumni);
    return testimonials.filter(t => !t.is_alumni);
  }

  // Open modal for add/edit
  function openModal(id: number | null = null) {
    editingId = id;
    modal.classList.remove('hidden');

    if (id) {
      const testimonial = testimonials.find(t => t.id === id);
      if (testimonial) {
        modalTitle.textContent = 'Edit Testimonial';
        (document.getElementById('testimonialId') as HTMLInputElement).value = String(id);
        (document.getElementById('name') as HTMLInputElement).value = testimonial.name || '';
        (document.getElementById('role') as HTMLInputElement).value = testimonial.role || '';
        (document.getElementById('batch') as HTMLInputElement).value = testimonial.batch || '';
        (document.getElementById('quote') as HTMLInputElement).value = testimonial.quote || '';
        (document.getElementById('message') as HTMLTextAreaElement).value = testimonial.message || '';
        (document.getElementById('photo_url') as HTMLInputElement).value = testimonial.photo_url || '';
        (document.getElementById('video_url') as HTMLInputElement).value = testimonial.video_url || '';
        (document.getElementById('order') as HTMLInputElement).value = String(testimonial.order || 0);
        (document.getElementById('is_active') as HTMLInputElement).checked = testimonial.is_active;
        
        const alumniRadio = testimonial.is_alumni ? 'true' : 'false';
        (document.querySelector(`input[name="is_alumni"][value="${alumniRadio}"]`) as HTMLInputElement).checked = true;
        batchField.classList.toggle('hidden', !testimonial.is_alumni);
      }
    } else {
      modalTitle.textContent = 'Add Testimonial';
      form.reset();
      batchField.classList.add('hidden');
    }
  }

  // Close modal
  function closeModal() {
    modal.classList.add('hidden');
    form.reset();
    editingId = null;
  }

  // Save testimonial
  async function saveTestimonial(e: Event) {
    e.preventDefault();

    const formData = new FormData(form);
    const data: any = {
      name: formData.get('name'),
      role: formData.get('role'),
      batch: formData.get('batch'),
      quote: formData.get('quote'),
      message: formData.get('message'),
      photo_url: formData.get('photo_url'),
      video_url: formData.get('video_url'),
      order: parseInt(formData.get('order') as string) || 0,
      is_active: (document.getElementById('is_active') as HTMLInputElement).checked,
      is_alumni: formData.get('is_alumni') === 'true'
    };

    try {
      const token = getSecureToken();
      const url = editingId 
        ? `${API_BASE_URL}/testimonials/${editingId}`
        : `${API_BASE_URL}/testimonials`;
      
      const response = await fetch(url, {
        method: editingId ? 'PUT' : 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (!response.ok) throw new Error('Failed to save testimonial');

      closeModal();
      loadTestimonials();
      alert('Testimonial saved successfully!');
    } catch (error) {
      console.error('Error saving testimonial:', error);
      alert('Failed to save testimonial. Please try again.');
    }
  }

  // Delete testimonial
  async function deleteTestimonial(id: number) {
    if (!confirm('Are you sure you want to delete this testimonial?')) return;

    try {
      const token = getSecureToken();
      const response = await fetch(`${API_BASE_URL}/testimonials/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) throw new Error('Failed to delete testimonial');

      loadTestimonials();
      alert('Testimonial deleted successfully!');
    } catch (error) {
      console.error('Error deleting testimonial:', error);
      alert('Failed to delete testimonial. Please try again.');
    }
  }

  // Event Listeners
  document.getElementById('btnAddTestimonial')?.addEventListener('click', () => openModal());
  document.getElementById('btnCloseModal')?.addEventListener('click', closeModal);
  document.getElementById('btnCancelForm')?.addEventListener('click', closeModal);
  form.addEventListener('submit', saveTestimonial);

  // Tab filters
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLButtonElement;
      currentFilter = target.dataset.filter!;
      
      document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active', 'border-blue-600', 'text-gray-700');
        b.classList.add('text-gray-500', 'border-transparent');
      });
      
      target.classList.add('active', 'border-blue-600', 'text-gray-700');
      target.classList.remove('text-gray-500', 'border-transparent');
      
      renderTestimonials();
    });
  });

  // Toggle batch field based on alumni selection
  document.querySelectorAll('input[name="is_alumni"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      batchField.classList.toggle('hidden', target.value !== 'true');
    });
  });

  // Make functions global for onclick handlers
  (window as any).editTestimonial = openModal;
  (window as any).deleteTestimonial = deleteTestimonial;

  // Initial load
  loadTestimonials();
</script>

<style>
  .tab-btn.active {
    @apply border-blue-600 text-gray-700;
  }
</style>